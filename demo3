#include <Wire.h>
#include "MAX30105.h"
#include "heartRate.h"
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

/* ===== OLED ===== */
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

/* ===== ESP32-C3 I2C ===== */
#define I2C_SDA 8
#define I2C_SCL 9

/* ===== MAX30102 ===== */
MAX30105 sensor;

/* ===== BPM ===== */
unsigned long lastBeat = 0;
float bpmEMA = 0;
#define EMA_ALPHA 0.3

/* ===== PULSE ANIMATION ===== */
bool pulseFlag = false;

/* ===== HAND DETECTION ===== */
#define IR_THRESHOLD 10000
bool handDetected = false;

/* ===== TIME ===== */
unsigned long lastOLED = 0;
unsigned long lastWait = 0;

void setup() {
  Serial.begin(115200);
  Wire.begin(I2C_SDA, I2C_SCL);

  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) while(1);
  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);

  if (!sensor.begin(Wire, I2C_SPEED_FAST)) {
    display.setTextSize(1);
    display.setCursor(0,0);
    display.println("MAX30102 ERROR");
    display.display();
    while(1);
  }

  sensor.setup(0x1F, 4, 2, 400, 411, 4096);
  sensor.setPulseAmplitudeIR(0x2A);
  sensor.setPulseAmplitudeRed(0x00);

  showWaiting();
}

void loop() {
  long irValue = sensor.getIR();

  /* ===== HAND DETECTION ===== */
  if (irValue < IR_THRESHOLD) {
    handDetected = false;
    resetBPM();
    if (millis() - lastWait > 300) {
      lastWait = millis();
      showWaiting();
    }
    return;
  }

  handDetected = true;

  /* ===== HEARTBEAT DETECTION ===== */
  if (checkForBeat(irValue)) {
    unsigned long now = millis();
    float delta = (now - lastBeat) / 1000.0;
    lastBeat = now;

    float currentBPM = 60.0 / delta;

    if (currentBPM > 45 && currentBPM < 180) {
      if (bpmEMA == 0) bpmEMA = currentBPM;
      else if (abs(currentBPM - bpmEMA) < 15)
        bpmEMA = EMA_ALPHA * currentBPM + (1 - EMA_ALPHA) * bpmEMA;

      Serial.print("BPM: "); Serial.println(round(bpmEMA));
      pulseFlag = true;
    }
  }

  /* ===== UPDATE OLED ===== */
  if (millis() - lastOLED > 150) {
    lastOLED = millis();
    showBPM(round(bpmEMA), pulseFlag);
    pulseFlag = false;
  }
}

/* ===== RESET BPM ===== */
void resetBPM() {
  bpmEMA = 0;
}

/* ===== OLED: SHOW BPM + PULSE ===== */
void showBPM(uint8_t bpmVal, bool pulse) {
  display.clearDisplay();

  display.setTextSize(1);
  display.setCursor(32,0);
  display.println("HEART RATE");

  display.setTextSize(3);
  display.setCursor(18,22);
  if (bpmVal>0) display.print(bpmVal);
  else display.print("--");
  display.println(" BPM");

  if (pulse) {
    display.fillCircle(110,10,5,SSD1306_WHITE);
  }

  display.display();
}

/* ===== OLED: WAITING ===== */
void showWaiting() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setCursor(20,12);
  display.println("DAT NGON TAY");

  display.setTextSize(2);
  display.setCursor(40,32);
  display.println("...");
  display.display();
}
