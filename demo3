#include <Wire.h>
#include "MAX30105.h"
#include "heartRate.h"
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

/* ===== OLED ===== */
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

/* ===== ESP32-C3 I2C ===== */
#define I2C_SDA 8
#define I2C_SCL 9

/* ===== MAX30102 ===== */
MAX30105 sensor;

/* ===== BPM ===== */
unsigned long lastBeat = 0;
float bpm = 0;
float bpmEMA = 0; // EMA cho nhịp mượt
#define EMA_ALPHA 0.3 // hệ số làm mượt

/* ===== PHÁT HIỆN TAY ===== */
#define IR_THRESHOLD 10000
bool handDetected = false;

/* ===== THỜI GIAN ===== */
unsigned long lastOLED = 0;
unsigned long lastWait = 0;
unsigned long lastPulseBlink = 0;
bool pulseState = false;

void setup() {
  Serial.begin(115200);
  Wire.begin(I2C_SDA, I2C_SCL);

  /* OLED INIT */
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) while (1);
  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);

  /* MAX30102 INIT */
  if (!sensor.begin(Wire, I2C_SPEED_FAST)) {
    display.setTextSize(1);
    display.setCursor(0, 0);
    display.println("MAX30102 ERROR");
    display.display();
    while (1);
  }

  sensor.setup(0x1F, 4, 2, 400, 411, 4096);
  sensor.setPulseAmplitudeIR(0x2A);
  sensor.setPulseAmplitudeRed(0x00);

  showWaiting();
}

void loop() {
  long irValue = sensor.getIR();

  /* ===== KHÔNG CÓ NGÓN TAY ===== */
  if (irValue < IR_THRESHOLD) {
    handDetected = false;
    resetBPM();
    if (millis() - lastWait > 300) {
      lastWait = millis();
      showWaiting();
    }
    return;
  }

  handDetected = true;

  /* ===== PHÁT HIỆN NHỊP TIM ===== */
  if (checkForBeat(irValue)) {
    unsigned long now = millis();
    float delta = (now - lastBeat) / 1000.0;
    lastBeat = now;

    float currentBPM = 60.0 / delta;

    if (currentBPM > 45 && currentBPM < 180) {
      // EMA làm mượt
      if (bpmEMA == 0) bpmEMA = currentBPM;
      else bpmEMA = EMA_ALPHA * currentBPM + (1 - EMA_ALPHA) * bpmEMA;

      Serial.print("BPM: ");
      Serial.println(round(bpmEMA));

      // Nhấp nháy nhịp tim
      pulseState = true;
      lastPulseBlink = millis();
    }
  }

  /* ===== CẬP NHẬT OLED ===== */
  if (millis() - lastOLED > 150) { // cập nhật 150ms đủ mượt
    lastOLED = millis();
    showBPM(round(bpmEMA), pulseState);
    pulseState = false;
  }
}

/* ===== RESET ===== */
void resetBPM() {
  bpm = 0;
  bpmEMA = 0;
}

/* ===== OLED: CHỜ ĐẶT TAY ===== */
void showWaiting() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setCursor(20, 12);
  display.println("DAT NGON TAY");

  display.setTextSize(2);
  display.setCursor(40, 32);
  display.println("...");
  display.display();
}

/* ===== OLED: HIỂN THỊ BPM + NHỊP TIM NHẤP NHÁY ===== */
void showBPM(int bpmValue, bool pulse) {
  display.clearDisplay();

  // Tiêu đề
  display.setTextSize(1);
  display.setCursor(32, 0);
  display.println("HEART RATE");

  // Nhịp tim
  display.setTextSize(3);
  display.setCursor(18, 22);
  if (bpmValue > 0) display.print(bpmValue);
  else display.print("--");
  display.println(" BPM");

  // Nhấp nháy theo nhịp tim
  if (pulse) {
    display.fillCircle(110, 10, 5, SSD1306_WHITE);
  }

  display.display();
}
