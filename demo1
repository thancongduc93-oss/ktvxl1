#include <Wire.h>
#include "MAX30105.h"
#include "heartRate.h"
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

/* ===== OLED ===== */
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

/* ===== ESP32-C3 I2C ===== */
#define I2C_SDA 8
#define I2C_SCL 9

/* ===== MAX30102 ===== */
MAX30105 sensor;

/* ===== BPM ===== */
unsigned long lastBeat = 0;
float bpm = 0;
float lastBpm = 0;
int bpmAvg = 0;

/* ===== LÀM MƯỢT ===== */
#define RATE_SIZE 8
float rates[RATE_SIZE];
byte rateIndex = 0;

/* ===== PHÁT HIỆN TAY ===== */
#define IR_THRESHOLD 10000
unsigned long fingerTime = 0;
bool fastMode = true; // đo nhanh ban đầu

/* ===== THỜI GIAN ===== */
unsigned long lastOLED = 0;
unsigned long lastWait = 0;

void setup() {
  Serial.begin(115200);
  Wire.begin(I2C_SDA, I2C_SCL);

  /* OLED INIT */
  if (!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) while (1);
  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);

  /* MAX30102 INIT */
  if (!sensor.begin(Wire, I2C_SPEED_FAST)) {
    display.setTextSize(1);
    display.setCursor(0, 0);
    display.println("MAX30102 ERROR");
    display.display();
    while (1);
  }

  /* CẤU HÌNH CHUẨN – ỔN ĐỊNH BPM */
  sensor.setup(
    0x1F,   // LED brightness
    4,      // Sample average
    2,      // IR ONLY
    400,    // Sample rate Hz
    411,    // Pulse width
    4096    // ADC range
  );
  sensor.setPulseAmplitudeIR(0x2A);
  sensor.setPulseAmplitudeRed(0x00);

  showWaiting();
}

void loop() {
  long irValue = sensor.getIR();

  /* ===== KHÔNG CÓ NGÓN TAY ===== */
  if (irValue < IR_THRESHOLD) {
    bpmAvg = 0;
    lastBpm = 0;
    rateIndex = 0;
    fastMode = true;
    fingerTime = 0;

    if (millis() - lastWait > 300) {
      lastWait = millis();
      showWaiting();
    }
    return;
  }

  /* ===== GHI NHỚ THỜI ĐIỂM ĐẶT TAY ===== */
  if (fingerTime == 0) fingerTime = millis();

  /* ===== PHÁT HIỆN NHỊP TIM ===== */
  if (checkForBeat(irValue)) {
    unsigned long now = millis();
    float delta = (now - lastBeat) / 1000.0;
    lastBeat = now;

    if (delta > 0.3 && delta < 1.5) { // BPM từ 40–200
      bpm = 60.0 / delta;

      /* ===== FAST MODE: nhảy số liền ===== */
      if (fastMode) {
        bpmAvg = round(bpm);
        lastBpm = bpm;
        if (millis() - fingerTime > 2000) fastMode = false;
      }

      /* ===== STABLE MODE: trung bình 8 nhịp ===== */
      else {
        if (bpm > 45 && bpm < 180 && abs(bpm - lastBpm) < 12) {
          lastBpm = bpm;

          rates[rateIndex++] = bpm;
          rateIndex %= RATE_SIZE;

          float sum = 0;
          for (byte i = 0; i < RATE_SIZE; i++) sum += rates[i];
          bpmAvg = round(sum / RATE_SIZE);
        }
      }

      Serial.println(bpmAvg);
    }
  }

  /* ===== CẬP NHẬT OLED LIÊN TỤC ===== */
  if (millis() - lastOLED > 100) {
    lastOLED = millis();
    showBPM(bpmAvg); // hiển thị nhảy số trực tiếp
  }
}

/* ===== OLED: CHỜ ĐẶT TAY ===== */
void showWaiting() {
  display.clearDisplay();
  display.setTextSize(1);
  display.setCursor(20, 12);
  display.println("DAT NGON TAY");

  display.setTextSize(2);
  display.setCursor(40, 32);
  display.println("...");
  display.display();
}

/* ===== OLED: HIỂN THỊ BPM ===== */
void showBPM(int bpmValue) {
  display.clearDisplay();

  display.setTextSize(1);
  display.setCursor(32, 0);
  display.println("HEART RATE");

  display.setTextSize(3);
  display.setCursor(18, 22);

  if (bpmValue > 0) {
    display.print(bpmValue);
    display.println(" BPM");
  } else {
    display.println("-- BPM");
  }

  display.display();
}
