/*
 * ============================================
 * THIáº¾T Bá»Š ÄO NHá»ŠP TIM VÃ€ SPO2 - MAX30102
 * ESP32-C3 + MAX30102 + Web Dashboard
 * ============================================
 * TÃ­nh nÄƒng:
 * - Äo nhá»‹p tim (Heart Rate)
 * - Äo ná»“ng Ä‘á»™ oxy trong mÃ¡u (SpO2)
 * - Äo nhiá»‡t Ä‘á»™ cÆ¡ thá»ƒ
 * - Web dashboard real-time
 * - LÆ°u lá»‹ch sá»­ 60 láº§n Ä‘o
 * - Thá»‘ng kÃª min/max/trung bÃ¬nh
 * - Cáº£nh bÃ¡o báº¥t thÆ°á»ng
 * - LED RGB hiá»ƒn thá»‹ tráº¡ng thÃ¡i
 * ============================================
 */

#include <Wire.h>
#include "MAX30105.h"
#include <WiFi.h>
#include <WebServer.h>

// ========== Cáº¤U HÃŒNH WIFI ==========
const char* ssid = "MU VO DICH";
const char* password = "12344321";

// ========== KHá»I Táº O CÃC THÃ€NH PHáº¦N ==========
MAX30105 sensor;
WebServer server(80);

// ========== BIáº¾N ÄO ==========
float heartRate = 0;
float spo2 = 0;
float temperature = 0;
bool fingerDetected = false;

// ========== LÆ¯U Lá»ŠCH Sá»¬ (60 Láº¦N ÄO) ==========
#define HISTORY_SIZE 60
float hrHistory[HISTORY_SIZE];
float spo2History[HISTORY_SIZE];
int historyIndex = 0;
int historyCount = 0;

// ========== CÃ€I Äáº¶T Cáº¢NH BÃO ==========
bool alertEnabled = true;
int hrMin = 50;    // Nhá»‹p tim tá»‘i thiá»ƒu
int hrMax = 120;   // Nhá»‹p tim tá»‘i Ä‘a
int spo2Min = 90;  // SpO2 tá»‘i thiá»ƒu

// ========== LED RGB PINS ==========
#define LED_R 10
#define LED_G 3
#define LED_B 4

// ========== BUFFER Äá»ŒC Dá»® LIá»†U ==========
#define BUFFER_SIZE 100
uint32_t irBuffer[BUFFER_SIZE];
uint32_t redBuffer[BUFFER_SIZE];

// ========== SETUP - KHá»I Táº O ==========
void setup() {
  Serial.begin(115200);
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘   THIáº¾T Bá»Š ÄO NHá»ŠP TIM MAX30102       â•‘");
  Serial.println("â•‘   ESP32-C3 + Web Dashboard             â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  // Setup LED RGB
  pinMode(LED_R, OUTPUT);
  pinMode(LED_G, OUTPUT);
  pinMode(LED_B, OUTPUT);
  setLED(0, 0, 255); // Xanh dÆ°Æ¡ng = Ä‘ang khá»Ÿi Ä‘á»™ng
  
  Serial.println("ğŸ”§ Khá»Ÿi Ä‘á»™ng I2C...");
  Wire.begin(8, 9); // SDA=GPIO8, SCL=GPIO9
  Wire.setClock(400000); // 400kHz
  
  Serial.println("ğŸ”§ TÃ¬m kiáº¿m MAX30102...");
  if (!sensor.begin(Wire, I2C_SPEED_FAST)) {
    Serial.println("âŒ KHÃ”NG TÃŒM THáº¤Y MAX30102!");
    Serial.println("Kiá»ƒm tra káº¿t ná»‘i:");
    Serial.println("  VIN â†’ 3.3V");
    Serial.println("  GND â†’ GND");
    Serial.println("  SDA â†’ GPIO 8");
    Serial.println("  SCL â†’ GPIO 9");
    setLED(255, 0, 0); // Äá» = lá»—i
    while (1) {
      delay(1000);
    }
  }
  
  Serial.println("âœ… MAX30102 Ä‘Ã£ sáºµn sÃ ng!");
  
  // Cáº¥u hÃ¬nh cáº£m biáº¿n tá»‘i Æ°u
  Serial.println("ğŸ”§ Cáº¥u hÃ¬nh cáº£m biáº¿n...");
  
  // TÄƒng Ä‘á»™ sÃ¡ng LED Ä‘á»ƒ dá»… phÃ¡t hiá»‡n hÆ¡n
  byte ledBrightness = 0x7F; // TÄƒng tá»« 0x3F lÃªn 0x7F (127)
  byte sampleAverage = 4;
  byte ledMode = 2; // Red + IR
  int sampleRate = 400;
  int pulseWidth = 411;
  int adcRange = 4096;
  
  sensor.setup(ledBrightness, sampleAverage, ledMode, sampleRate, pulseWidth, adcRange);
  
  // TÄƒng cÆ°á»ng Ä‘á»™ LED Red vÃ  IR
  sensor.setPulseAmplitudeRed(0x1F); // TÄƒng tá»« 0x0A lÃªn 0x1F
  sensor.setPulseAmplitudeIR(0x1F);  // TÄƒng tá»« 0x0A lÃªn 0x1F
  sensor.enableDIETEMPRDY();
  
  Serial.println("âœ… Cáº¥u hÃ¬nh: LED Brightness = 127, Pulse Amplitude = 31");
  
  // Káº¿t ná»‘i WiFi
  Serial.println("\nğŸ“¡ Äang káº¿t ná»‘i WiFi...");
  Serial.print("SSID: ");
  Serial.println(ssid);
  
  WiFi.mode(WIFI_STA);
  WiFi.begin(ssid, password);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(500);
    Serial.print(".");
    attempts++;
  }
  
  Serial.println();
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("âœ… WiFi Ä‘Ã£ káº¿t ná»‘i!");
    Serial.print("ğŸ“± Äá»‹a chá»‰ IP: http://");
    Serial.println(WiFi.localIP());
    Serial.println("ğŸ‘‰ Má»Ÿ trÃ¬nh duyá»‡t vÃ  truy cáº­p Ä‘á»‹a chá»‰ IP trÃªn");
    
    setupWebServer();
    server.begin();
    setLED(0, 255, 0); // Xanh lÃ¡ = sáºµn sÃ ng
  } else {
    Serial.println("âš ï¸  KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c WiFi");
    Serial.println("Thiáº¿t bá»‹ váº«n hoáº¡t Ä‘á»™ng, chá»‰ khÃ´ng cÃ³ web dashboard");
    setLED(255, 255, 0); // VÃ ng = khÃ´ng cÃ³ WiFi
  }
  
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘  ğŸ©º Äáº¶T NGÃ“N TAY LÃŠN Cáº¢M BIáº¾N         â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n");
  
  // Test Ä‘á»c giÃ¡ trá»‹ IR
  Serial.println("ğŸ” Äang test cáº£m biáº¿n...");
  delay(1000);
  for (int i = 0; i < 5; i++) {
    sensor.check();
    uint32_t ir = sensor.getIR();
    uint32_t red = sensor.getRed();
    Serial.print("Test ");
    Serial.print(i+1);
    Serial.print(": IR=");
    Serial.print(ir);
    Serial.print(", RED=");
    Serial.println(red);
    delay(500);
  }
  Serial.println("âœ… Test hoÃ n táº¥t! Báº¯t Ä‘áº§u Ä‘o...\n");
  
  delay(1000);
}

// ========== LOOP - VÃ’NG Láº¶P CHÃNH ==========
void loop() {
  // Xá»­ lÃ½ cÃ¡c yÃªu cáº§u web
  if (WiFi.status() == WL_CONNECTED) {
    server.handleClient();
  }
  
  // Äo cÃ¡c chá»‰ sá»‘ sá»©c khá»e
  measureVitals();
  
  // Äá»c nhiá»‡t Ä‘á»™ tá»« cáº£m biáº¿n
  temperature = sensor.readTemperature();
  
  // LÆ°u vÃ o lá»‹ch sá»­
  saveToHistory();
  
  // Kiá»ƒm tra vÃ  cáº£nh bÃ¡o
  checkAlerts();
  
  // Cáº­p nháº­t LED tráº¡ng thÃ¡i
  updateStatusLED();
  
  // In káº¿t quáº£ ra Serial Monitor
  printResults();
  
  delay(1000); // Äo má»—i giÃ¢y
}

// ========== TÃNH NÄ‚NG 1: WEB SERVER ==========
void setupWebServer() {
  // Trang chá»§ - Dashboard
  server.on("/", HTTP_GET, handleRoot);
  
  // API endpoint - Láº¥y dá»¯ liá»‡u real-time
  server.on("/data", HTTP_GET, handleData);
  
  // Xem lá»‹ch sá»­
  server.on("/history", HTTP_GET, handleHistory);
  
  // Xem thá»‘ng kÃª
  server.on("/stats", HTTP_GET, handleStats);
  
  // XÃ³a lá»‹ch sá»­
  server.on("/clear", HTTP_GET, handleClear);
  
  Serial.println("âœ… Web server Ä‘Ã£ khá»Ÿi Ä‘á»™ng");
}

void handleRoot() {
  String html = "<!DOCTYPE html><html><head>";
  html += "<meta charset='UTF-8'>";
  html += "<meta name='viewport' content='width=device-width, initial-scale=1.0'>";
  html += "<title>Thiáº¿t bá»‹ Ä‘o nhá»‹p tim</title>";
  html += "<style>";
  html += "* { margin: 0; padding: 0; box-sizing: border-box; }";
  html += "body { font-family: 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #fff; padding: 20px; min-height: 100vh; }";
  html += ".container { max-width: 800px; margin: 0 auto; }";
  html += "h1 { text-align: center; margin-bottom: 30px; font-size: 2em; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }";
  html += ".card { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 20px; padding: 25px; margin: 15px 0; box-shadow: 0 8px 32px rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); }";
  html += ".status-card { display: flex; align-items: center; font-size: 1.2em; }";
  html += ".status-indicator { width: 20px; height: 20px; border-radius: 50%; margin-right: 15px; animation: pulse 2s infinite; }";
  html += "@keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }";
  html += ".ok { background: #00ff00; box-shadow: 0 0 20px #00ff00; }";
  html += ".warning { background: #ffaa00; box-shadow: 0 0 20px #ffaa00; }";
  html += ".error { background: #ff0000; box-shadow: 0 0 20px #ff0000; }";
  html += ".metric-card { text-align: center; }";
  html += ".metric-label { font-size: 1.2em; margin-bottom: 10px; opacity: 0.9; }";
  html += ".metric-value { font-size: 4em; font-weight: bold; margin: 15px 0; text-shadow: 2px 2px 8px rgba(0,0,0,0.3); transition: color 0.3s; }";
  html += ".metric-unit { font-size: 0.4em; opacity: 0.8; }";
  html += ".button-group { display: flex; gap: 10px; flex-wrap: wrap; }";
  html += "button { flex: 1; min-width: 150px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); padding: 15px 20px; border-radius: 12px; cursor: pointer; font-size: 1em; font-weight: bold; transition: all 0.3s; }";
  html += "button:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }";
  html += "button:active { transform: translateY(0); }";
  html += ".footer { text-align: center; margin-top: 30px; font-size: 0.9em; opacity: 0.7; }";
  html += "@media (max-width: 600px) { .metric-value { font-size: 3em; } h1 { font-size: 1.5em; } }";
  html += "</style>";
  html += "<script>";
  html += "function updateData() {";
  html += "  fetch('/data').then(r => r.json()).then(d => {";
  html += "    document.getElementById('hr').innerHTML = d.hr > 0 ? d.hr : '--';";
  html += "    document.getElementById('spo2').innerHTML = d.spo2 > 0 ? d.spo2 : '--';";
  html += "    document.getElementById('temp').innerHTML = d.temp;";
  html += "    const statusEl = document.getElementById('status');";
  html += "    const statusText = document.getElementById('status-text');";
  html += "    if (d.finger) {";
  html += "      statusEl.className = 'status-indicator ok';";
  html += "      statusText.innerHTML = 'âœ… NgÃ³n tay Ä‘Ã£ Ä‘áº·t Ä‘Ãºng';";
  html += "    } else {";
  html += "      statusEl.className = 'status-indicator error';";
  html += "      statusText.innerHTML = 'âŒ Vui lÃ²ng Ä‘áº·t ngÃ³n tay';";
  html += "    }";
  html += "    const hrEl = document.getElementById('hr');";
  html += "    if (d.hr > 0) {";
  html += "      hrEl.style.color = (d.hr >= 50 && d.hr <= 120) ? '#00ff88' : '#ffaa00';";
  html += "    } else {";
  html += "      hrEl.style.color = '#666';";
  html += "    }";
  html += "    const spo2El = document.getElementById('spo2');";
  html += "    if (d.spo2 > 0) {";
  html += "      spo2El.style.color = d.spo2 >= 90 ? '#00ff88' : '#ff4444';";
  html += "    } else {";
  html += "      spo2El.style.color = '#666';";
  html += "    }";
  html += "  }).catch(e => console.error('Error:', e));";
  html += "}";
  html += "setInterval(updateData, 1000);";
  html += "window.onload = updateData;";
  html += "</script>";
  html += "</head><body>";
  html += "<div class='container'>";
  html += "<h1>ğŸ’“ THIáº¾T Bá»Š ÄO NHá»ŠP TIM MAX30102</h1>";
  
  // Status card
  html += "<div class='card status-card'>";
  html += "<div id='status' class='status-indicator ok'></div>";
  html += "<div id='status-text'>Äang kiá»ƒm tra...</div>";
  html += "</div>";
  
  // Heart Rate
  html += "<div class='card metric-card'>";
  html += "<div class='metric-label'>â¤ï¸ NHá»ŠP TIM (Heart Rate)</div>";
  html += "<div class='metric-value' id='hr'>--<span class='metric-unit'>BPM</span></div>";
  html += "</div>";
  
  // SpO2
  html += "<div class='card metric-card'>";
  html += "<div class='metric-label'>ğŸ« Ná»’NG Äá»˜ OXY (SpO2)</div>";
  html += "<div class='metric-value' id='spo2'>--<span class='metric-unit'>%</span></div>";
  html += "</div>";
  
  // Temperature
  html += "<div class='card metric-card'>";
  html += "<div class='metric-label'>ğŸŒ¡ï¸ NHIá»†T Äá»˜ (Temperature)</div>";
  html += "<div class='metric-value' id='temp' style='font-size: 2.5em;'>--<span class='metric-unit'>Â°C</span></div>";
  html += "</div>";
  
  // Buttons
  html += "<div class='card'>";
  html += "<div class='button-group'>";
  html += "<button onclick='fetch(\"/history\").then(r=>r.text()).then(alert)'>ğŸ“Š Xem lá»‹ch sá»­</button>";
  html += "<button onclick='fetch(\"/stats\").then(r=>r.text()).then(alert)'>ğŸ“ˆ Thá»‘ng kÃª</button>";
  html += "<button onclick='if(confirm(\"XÃ³a toÃ n bá»™ lá»‹ch sá»­?\")){fetch(\"/clear\").then(r=>r.text()).then(alert)}'>ğŸ—‘ï¸ XÃ³a lá»‹ch sá»­</button>";
  html += "</div></div>";
  
  // Footer
  html += "<div class='footer'>";
  html += "âš ï¸ Thiáº¿t bá»‹ nÃ y chá»‰ Ä‘á»ƒ tham kháº£o, khÃ´ng thay tháº¿ thiáº¿t bá»‹ y táº¿ chuyÃªn nghiá»‡p<br>";
  html += "Developed with â¤ï¸ for health monitoring | ESP32-C3 + MAX30102";
  html += "</div>";
  
  html += "</div></body></html>";
  
  server.send(200, "text/html", html);
}

void handleData() {
  String json = "{";
  json += "\"hr\":" + String(heartRate, 1) + ",";
  json += "\"spo2\":" + String(spo2, 1) + ",";
  json += "\"temp\":" + String(temperature, 1) + ",";
  json += "\"finger\":" + String(fingerDetected ? "true" : "false");
  json += "}";
  server.send(200, "application/json", json);
}

void handleHistory() {
  String result = "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n";
  result += "â•‘       Lá»ŠCH Sá»¬ ÄO (" + String(historyCount) + " Láº¦N ÄO)          â•‘\n";
  result += "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";
  
  if (historyCount == 0) {
    result = "ChÆ°a cÃ³ dá»¯ liá»‡u.\nHÃ£y Ä‘áº·t ngÃ³n tay lÃªn cáº£m biáº¿n Ä‘á»ƒ báº¯t Ä‘áº§u Ä‘o!";
  } else {
    for (int i = 0; i < historyCount; i++) {
      result += String(i+1) + ". ";
      result += "Nhá»‹p tim: " + String(hrHistory[i], 1) + " BPM";
      result += " | SpO2: " + String(spo2History[i], 1) + "%\n";
    }
  }
  
  server.send(200, "text/plain; charset=utf-8", result);
}

void handleStats() {
  if (historyCount == 0) {
    server.send(200, "text/plain; charset=utf-8", "ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ thá»‘ng kÃª!\nHÃ£y Ä‘o Ã­t nháº¥t má»™t láº§n.");
    return;
  }
  
  float hrMin = 999, hrMax = 0, hrSum = 0;
  float spo2Min = 999, spo2Max = 0, spo2Sum = 0;
  int hrCount = 0, spo2Count = 0;
  
  for (int i = 0; i < historyCount; i++) {
    if (hrHistory[i] > 0) {
      if (hrHistory[i] < hrMin) hrMin = hrHistory[i];
      if (hrHistory[i] > hrMax) hrMax = hrHistory[i];
      hrSum += hrHistory[i];
      hrCount++;
    }
    if (spo2History[i] > 0) {
      if (spo2History[i] < spo2Min) spo2Min = spo2History[i];
      if (spo2History[i] > spo2Max) spo2Max = spo2History[i];
      spo2Sum += spo2History[i];
      spo2Count++;
    }
  }
  
  String result = "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—\n";
  result += "â•‘            THá»NG KÃŠ CHI TIáº¾T           â•‘\n";
  result += "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n";
  
  result += "ğŸ“Š NHá»ŠP TIM (Heart Rate):\n";
  result += "  â€¢ Trung bÃ¬nh: " + String(hrSum/hrCount, 1) + " BPM\n";
  result += "  â€¢ Tháº¥p nháº¥t:  " + String(hrMin, 1) + " BPM\n";
  result += "  â€¢ Cao nháº¥t:   " + String(hrMax, 1) + " BPM\n";
  result += "  â€¢ Sá»‘ máº«u:     " + String(hrCount) + "\n\n";
  
  result += "ğŸ“Š Ná»’NG Äá»˜ OXY (SpO2):\n";
  result += "  â€¢ Trung bÃ¬nh: " + String(spo2Sum/spo2Count, 1) + " %\n";
  result += "  â€¢ Tháº¥p nháº¥t:  " + String(spo2Min, 1) + " %\n";
  result += "  â€¢ Cao nháº¥t:   " + String(spo2Max, 1) + " %\n";
  result += "  â€¢ Sá»‘ máº«u:     " + String(spo2Count) + "\n\n";
  
  result += "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n";
  result += "Tá»•ng sá»‘ láº§n Ä‘o: " + String(historyCount) + "\n";
  
  // ÄÃ¡nh giÃ¡ sá»©c khá»e
  result += "\nğŸ’¡ ÄÃNH GIÃ:\n";
  float avgHR = hrSum/hrCount;
  float avgSpO2 = spo2Sum/spo2Count;
  
  if (avgHR >= 60 && avgHR <= 100) {
    result += "  âœ… Nhá»‹p tim bÃ¬nh thÆ°á»ng\n";
  } else if (avgHR < 60) {
    result += "  âš ï¸  Nhá»‹p tim cháº­m (Bradycardia)\n";
  } else {
    result += "  âš ï¸  Nhá»‹p tim nhanh (Tachycardia)\n";
  }
  
  if (avgSpO2 >= 95) {
    result += "  âœ… Ná»“ng Ä‘á»™ oxy tá»‘t\n";
  } else if (avgSpO2 >= 90) {
    result += "  âš ï¸  Ná»“ng Ä‘á»™ oxy hÆ¡i tháº¥p\n";
  } else {
    result += "  ğŸš¨ Ná»“ng Ä‘á»™ oxy tháº¥p - cáº§n khÃ¡m bÃ¡c sÄ©\n";
  }
  
  server.send(200, "text/plain; charset=utf-8", result);
}

void handleClear() {
  historyCount = 0;
  historyIndex = 0;
  Serial.println("âœ… ÄÃ£ xÃ³a toÃ n bá»™ lá»‹ch sá»­!");
  server.send(200, "text/plain; charset=utf-8", "âœ… ÄÃ£ xÃ³a lá»‹ch sá»­ thÃ nh cÃ´ng!");
}

// ========== TÃNH NÄ‚NG 2: LÆ¯U Lá»ŠCH Sá»¬ ==========
void saveToHistory() {
  if (fingerDetected && heartRate > 0 && spo2 > 0) {
    hrHistory[historyIndex] = heartRate;
    spo2History[historyIndex] = spo2;
    
    historyIndex = (historyIndex + 1) % HISTORY_SIZE;
    if (historyCount < HISTORY_SIZE) {
      historyCount++;
    }
  }
}

// ========== TÃNH NÄ‚NG 3: Cáº¢NH BÃO ==========
void checkAlerts() {
  if (!alertEnabled || !fingerDetected) return;
  
  if (heartRate > 0) {
    if (heartRate < hrMin) {
      Serial.println("âš ï¸  Cáº¢NH BÃO: Nhá»‹p tim quÃ¡ tháº¥p! (" + String(heartRate, 1) + " BPM)");
      Serial.println("    NgÆ°á»¡ng tá»‘i thiá»ƒu: " + String(hrMin) + " BPM");
    } else if (heartRate > hrMax) {
      Serial.println("âš ï¸  Cáº¢NH BÃO: Nhá»‹p tim quÃ¡ cao! (" + String(heartRate, 1) + " BPM)");
      Serial.println("    NgÆ°á»¡ng tá»‘i Ä‘a: " + String(hrMax) + " BPM");
    }
  }
  
  if (spo2 > 0 && spo2 < spo2Min) {
    Serial.println("âš ï¸  Cáº¢NH BÃO: Ná»“ng Ä‘á»™ oxy tháº¥p! (" + String(spo2, 1) + "%)");
    Serial.println("    NgÆ°á»¡ng tá»‘i thiá»ƒu: " + String(spo2Min) + "%");
  }
}

// ========== TÃNH NÄ‚NG 4: LED RGB STATUS ==========
void updateStatusLED() {
  if (!fingerDetected) {
    setLED(255, 0, 0); // ğŸ”´ Äá» = KhÃ´ng cÃ³ ngÃ³n tay
  } else if ((heartRate > 0 && (heartRate < hrMin || heartRate > hrMax)) || 
             (spo2 > 0 && spo2 < spo2Min)) {
    setLED(255, 165, 0); // ğŸŸ  Cam = Cáº£nh bÃ¡o
  } else {
    setLED(0, 255, 0); // ğŸŸ¢ Xanh = OK
  }
}

void setLED(int r, int g, int b) {
  // Common Anode RGB LED (Ä‘áº£o ngÆ°á»£c giÃ¡ trá»‹)
  analogWrite(LED_R, 255 - r);
  analogWrite(LED_G, 255 - g);
  analogWrite(LED_B, 255 - b);
}

// ========== ÄO CÃC CHá»ˆ Sá» Sá»NG ==========
void measureVitals() {
  // Thu tháº­p dá»¯ liá»‡u buffer
  for (int i = 0; i < BUFFER_SIZE; i++) {
    while (sensor.available() == false) {
      sensor.check();
    }
    redBuffer[i] = sensor.getRed();
    irBuffer[i] = sensor.getIR();
    sensor.nextSample();
  }

  // Kiá»ƒm tra ngÃ³n tay (háº¡ ngÆ°á»¡ng xuá»‘ng 30000 Ä‘á»ƒ dá»… phÃ¡t hiá»‡n hÆ¡n)
  uint32_t irMean = calculateMean(irBuffer, BUFFER_SIZE);
  fingerDetected = (irMean > 30000); // Háº¡ tá»« 50000 xuá»‘ng 30000
  
  // Debug: In giÃ¡ trá»‹ IR Ä‘á»ƒ kiá»ƒm tra
  static int debugCount = 0;
  if (debugCount % 5 == 0) { // In má»—i 5 láº§n Ä‘o
    Serial.print("ğŸ” DEBUG - IR Mean: ");
    Serial.print(irMean);
    Serial.print(" | NgÆ°á»¡ng: 30000 | PhÃ¡t hiá»‡n: ");
    Serial.println(fingerDetected ? "CÃ“" : "KHÃ”NG");
  }
  debugCount++;

  if (fingerDetected) {
    heartRate = calculateHeartRate(irBuffer, BUFFER_SIZE);
    spo2 = calculateSpO2(redBuffer, irBuffer, BUFFER_SIZE);
    
    // Lá»c giÃ¡ trá»‹ khÃ´ng há»£p lá»‡
    if (heartRate < 40 || heartRate > 200) heartRate = 0;
    if (spo2 < 70 || spo2 > 100) spo2 = 0;
  } else {
    heartRate = 0;
    spo2 = 0;
  }
}

// TÃ­nh giÃ¡ trá»‹ trung bÃ¬nh
uint32_t calculateMean(uint32_t *buffer, int size) {
  uint64_t sum = 0;
  for (int i = 0; i < size; i++) {
    sum += buffer[i];
  }
  return sum / size;
}

// TÃ­nh Heart Rate báº±ng peak detection
float calculateHeartRate(uint32_t *irBuffer, int size) {
  float mean = calculateMean(irBuffer, size);
  float threshold = mean * 0.005; // 0.5% cá»§a mean
  
  float peakPositions[20];
  int peakCount = 0;
  
  // PhÃ¡t hiá»‡n Ä‘á»‰nh
  for (int i = 2; i < size - 2; i++) {
    if (irBuffer[i] > irBuffer[i-1] && 
        irBuffer[i] > irBuffer[i+1] &&
        irBuffer[i] > irBuffer[i-2] &&
        irBuffer[i] > irBuffer[i+2]) {
      
      float peak = irBuffer[i] - mean;
      if (peak > threshold && peakCount < 20) {
        peakPositions[peakCount++] = i;
      }
    }
  }

  if (peakCount < 2) return 0;

  // TÃ­nh khoáº£ng cÃ¡ch trung bÃ¬nh giá»¯a cÃ¡c Ä‘á»‰nh
  float avgDistance = 0;
  for (int i = 1; i < peakCount; i++) {
    avgDistance += peakPositions[i] - peakPositions[i-1];
  }
  avgDistance /= (peakCount - 1);

  // Chuyá»ƒn sang BPM (400 samples/sec)
  float bpm = (400.0 * 60.0) / avgDistance;
  
  return bpm;
}

// TÃ­nh SpO2 báº±ng R-value method
float calculateSpO2(uint32_t *redBuffer, uint32_t *irBuffer, int size) {
  float redAC = 0, redDC = 0;
  float irAC = 0, irDC = 0;
  
  // TÃ­nh DC (giÃ¡ trá»‹ trung bÃ¬nh)
  for (int i = 0; i < size; i++) {
    redDC += redBuffer[i];
    irDC += irBuffer[i];
  }
  redDC /= size;
  irDC /= size;
  
  // TÃ­nh AC (RMS cá»§a biáº¿n Ä‘á»™ng)
  for (int i = 0; i < size; i++) {
    float redDiff = redBuffer[i] - redDC;
    float irDiff = irBuffer[i] - irDC;
    redAC += redDiff * redDiff;
    irAC += irDiff * irDiff;
  }
  redAC = sqrt(redAC / size);
  irAC = sqrt(irAC / size);
  
  // TÃ­nh R-value
  float R = (redAC / redDC) / (irAC / irDC);
  
  // CÃ´ng thá»©c hiá»‡u chuáº©n SpO2 (tá»« Maxim Integrated)
  float spo2Value = -45.060 * R * R + 30.354 * R + 94.845;
  
  return spo2Value;
}

// In káº¿t quáº£ ra Serial Monitor
void printResults() {
  Serial.println("\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  
  Serial.print("â•‘ Tráº¡ng thÃ¡i: ");
  if (fingerDetected) {
    Serial.println("ğŸ‘† NgÃ³n tay OK           â•‘");
  } else {
    Serial.println("âŒ ChÆ°a Ä‘áº·t ngÃ³n tay      â•‘");
  }
  
  Serial.print("â•‘ Nhá»‹p tim:   ");
  if (heartRate > 0) {
    Serial.print(heartRate, 1);
    Serial.print(" BPM");
    if (heartRate >= 50 && heartRate <= 120) {
      Serial.println("   âœ…     â•‘");
    } else {
      Serial.println("   âš ï¸      â•‘");
    }
  } else {
    Serial.println("--                    â•‘");
  }
  
  Serial.print("â•‘ SpO2:       ");
  if (spo2 > 0) {
    Serial.print(spo2, 1);
    Serial.print(" %");
    if (spo2 >= 90) {
      Serial.println("       âœ…     â•‘");
    } else {
      Serial.println("       âš ï¸      â•‘");
    }
  } else {
    Serial.println("--                    â•‘");
  }
  
  Serial.print("â•‘ Nhiá»‡t Ä‘á»™:   ");
  Serial.print(temperature, 1);
  Serial.println(" Â°C               â•‘");
  
  Serial.print("â•‘ Lá»‹ch sá»­:    ");
  Serial.print(historyCount);
  Serial.println(" láº§n Ä‘o            â•‘");
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("â•Ÿâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¢");
    Serial.print("â•‘ ğŸŒ Web: http://");
    String ip = WiFi.localIP().toString();
    Serial.print(ip);
    int spaces = 20 - ip.length();
    for(int i = 0; i < spaces; i++) Serial.print(" ");
    Serial.println("â•‘");
  }
  
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
}
